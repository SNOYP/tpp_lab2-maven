<!DOCTYPE html>
<html lang="uk" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>–Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏–π CRUD (–ë–µ–∑–ø–µ—á–Ω–∏–π)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; padding: 20px; line-height: 1.6; }
        .container { max-width: 900px; margin: 0 auto; background-color: #1e1e1e; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5); }
        h1 { color: #00bcd4; text-align: center; border-bottom: 2px solid #00bcd4; padding-bottom: 10px; margin-bottom: 30px; }
        h3 { color: #bdbdbd; border-bottom: 1px solid #333; padding-bottom: 5px; margin-top: 30px; }
        .form-section { background-color: #2a2a2a; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #ff9800; }
        .form-group { margin-bottom: 15px; display: flex; align-items: center; }
        .form-group label { flex: 0 0 150px; margin-right: 10px; font-weight: bold; color: #e0e0e0; }
        .form-group input[type="text"], .form-group input[type="number"], .form-group select { flex-grow: 1; padding: 10px; border: 1px solid #555; border-radius: 4px; box-sizing: border-box; background-color: #333; color: #f0f0f0; }
        button { background-color: #ff9800; color: #1e1e1e; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold; transition: background-color 0.3s; }
        button:hover { background-color: #f57c00; }
        .message-box { padding: 15px; border-radius: 4px; margin-bottom: 20px; font-weight: bold; }
        .success { background-color: #388e3c; border: 1px solid #4CAF50; color: #e8f5e9; }
        .error { background-color: #d32f2f; border: 1px solid #F44336; color: #ffebee; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; background-color: #2a2a2a; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #444; }
        th { background-color: #333; color: #00bcd4; font-weight: 600; text-transform: uppercase; }
        tr:hover { background-color: #3a3a3a; }

        .table-container { margin-top: 40px; }

        .footer-link { text-align: center; margin-top: 30px; }
        .footer-link a { color: #00bcd4; text-decoration: none; transition: color 0.3s; }
        .footer-link a:hover { color: #80deea; }
    </style>
</head>
<body>
<div class="container">
    <h1>üéµ –Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–µ –î–æ–¥–∞–≤–∞–Ω–Ω—è –î–∞–Ω–∏—Ö (Secure CRUD)</h1>

    <div id="status-message" class="message-box" style="display:none;"></div>

    <div th:if="${message.startsWith('‚ùå')}" class="message-box error" th:text="${message}"></div>

    <div class="form-section">
        <h3>1. –î–æ–¥–∞—Ç–∏ –ù–æ–≤–∏–π –ñ–∞–Ω—Ä (genres)</h3>
        <form id="genre-form" data-endpoint="/api/secure-add/add-genre">
            <div class="form-group">
                <label for="genre_name">–ù–∞–∑–≤–∞ –ñ–∞–Ω—Ä—É:</label>
                <input type="text" id="genre_name" name="name" required placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥, Metal">
            </div>
            <button type="submit">–î–æ–¥–∞—Ç–∏ –ñ–∞–Ω—Ä</button>
        </form>
    </div>

    <div class="form-section" th:if="${!genresList.isEmpty()}">
        <h3>2. –î–æ–¥–∞—Ç–∏ –ù–æ–≤—É –ì—Ä—É–ø—É (groups)</h3>
        <form id="group-form" data-endpoint="/api/secure-add/add-group">

            <div class="form-group">
                <label for="group_genre_id">–í–∏–±—Ä–∞—Ç–∏ –ñ–∞–Ω—Ä:</label>
                <select id="group_genre_id" name="genre_id" required>
                    <option value="">-- –û–±–µ—Ä—ñ—Ç—å –∂–∞–Ω—Ä --</option>
                    <option th:each="genre : ${genresList}" th:value="${genre.key}" th:text="${genre.value}"></option>
                </select>
            </div>

            <div class="form-group">
                <label for="group_name">–ù–∞–∑–≤–∞ –ì—Ä—É–ø–∏:</label>
                <input type="text" id="group_name" name="name" required placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥, Iron Maiden">
            </div>

            <button type="submit">–î–æ–¥–∞—Ç–∏ –ì—Ä—É–ø—É</button>
        </form>
    </div>
    <div class="form-section" th:if="${genresList.isEmpty()}">
        <p style="color: #ff9800; font-weight: bold;">‚ö†Ô∏è –°–ø–æ—á–∞—Ç–∫—É –¥–æ–¥–∞–π—Ç–µ —Ö–æ—á–∞ –± –æ–¥–∏–Ω –ñ–∞–Ω—Ä, —â–æ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏ –ì—Ä—É–ø—É.</p>
    </div>

    <div class="form-section" th:if="${!genresList.isEmpty()}">
        <h3>3. –î–æ–¥–∞—Ç–∏ –ù–æ–≤—É –ü—ñ—Å–Ω—é (songs)</h3>
        <form id="song-form" data-endpoint="/api/secure-add/add-song">

            <div class="form-group">
                <label for="filter_genre_id">–§—ñ–ª—å—Ç—Ä –ø–æ –ñ–∞–Ω—Ä—É:</label>
                <select id="filter_genre_id">
                    <option value="">-- –í—Å—ñ –∂–∞–Ω—Ä–∏ --</option>
                    <option th:each="genre : ${genresList}" th:value="${genre.key}" th:text="${genre.value}"></option>
                </select>
            </div>

            <div class="form-group">
                <label for="song_group_id">–í–∏–±—Ä–∞—Ç–∏ –ì—Ä—É–ø—É:</label>
                <select id="song_group_id" name="group_id" required>
                    <option value="">-- –û–±–µ—Ä—ñ—Ç—å –≥—Ä—É–ø—É --</option>
                    <option th:each="group : ${groupsList}" th:value="${group.key}" th:text="${group.value}"></option>
                </select>
            </div>

            <div class="form-group">
                <label for="song_title">–ù–∞–∑–≤–∞ –ü—ñ—Å–Ω—ñ:</label>
                <input type="text" id="song_title" name="title" required placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥, The Trooper">
            </div>

            <div class="form-group">
                <label for="duration_seconds">–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å (—Å–µ–∫):</label>
                <input type="number" id="duration_seconds" name="duration_seconds" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥, 258" min="1">
            </div>

            <button type="submit">–î–æ–¥–∞—Ç–∏ –ü—ñ—Å–Ω—é</button>
        </form>
    </div>
    <div class="form-section" th:if="${groupsList.isEmpty() && !genresList.isEmpty()}">
        <p style="color: #ff9800; font-weight: bold;">‚ö†Ô∏è –°–ø–æ—á–∞—Ç–∫—É –¥–æ–¥–∞–π—Ç–µ —Ö–æ—á–∞ –± –æ–¥–Ω—É –ì—Ä—É–ø—É, —â–æ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏ –ü—ñ—Å–Ω—é.</p>
    </div>

    <div class="table-container">
        <h2>üìä –Ü—Å–Ω—É—é—á—ñ –î–∞–Ω—ñ —É –ë–∞–∑—ñ</h2>

        <h3 style="color: #4CAF50;">–¢–∞–±–ª–∏—Ü—è genres</h3>
        <table th:if="${!currentGenres.isEmpty()}">
            <thead>
            <tr>
                <th th:each="header : ${currentGenres[0].keySet()}" th:text="${header}">Header</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="row : ${currentGenres}">
                <td th:each="data : ${row.values()}" th:text="${data}">Data</td>
            </tr>
            </tbody>
        </table>
        <p th:if="${currentGenres.isEmpty()}" style="color: #aaa;">–¢–∞–±–ª–∏—Ü—è genres –ø–æ—Ä–æ–∂–Ω—è.</p>

        <h3 style="color: #4CAF50;">–¢–∞–±–ª–∏—Ü—è groups</h3>
        <table th:if="${!currentGroups.isEmpty()}">
            <thead>
            <tr>
                <th th:each="header : ${currentGroups[0].keySet()}" th:text="${header}">Header</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="row : ${currentGroups}">
                <td th:each="data : ${row.values()}" th:text="${data}">Data</td>
            </tr>
            </tbody>
        </table>
        <p th:if="${currentGroups.isEmpty()}" style="color: #aaa;">–¢–∞–±–ª–∏—Ü—è groups –ø–æ—Ä–æ–∂–Ω—è.</p>

        <h3 style="color: #4CAF50;">–¢–∞–±–ª–∏—Ü—è songs</h3>
        <table th:if="${!currentSongs.isEmpty()}">
            <thead>
            <tr>
                <th th:each="header : ${currentSongs[0].keySet()}" th:text="${header}">Header</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="row : ${currentSongs}">
                <td th:each="data : ${row.values()}" th:text="${data}">Data</td>
            </tr>
            </tbody>
        </table>
        <p th:if="${currentSongs.isEmpty()}" style="color: #aaa;">–¢–∞–±–ª–∏—Ü—è songs –ø–æ—Ä–æ–∂–Ω—è.</p>
    </div>

    <div class="footer-link">
        <p>–Ø–∫—â–æ –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä—É–≤–∞—Ç–∏ SQL Injection:</p>
        <a href="/vulnerable/">–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –£—Ä–∞–∑–ª–∏–≤–æ–≥–æ –Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É</a>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const forms = document.querySelectorAll('.form-section form');
        const statusMessage = document.getElementById('status-message');
        const filterGenreSelect = document.getElementById('filter_genre_id');
        const songGroupSelect = document.getElementById('song_group_id');

        const initialGroups = Array.from(songGroupSelect.options).map(option => ({
            value: option.value,
            text: option.textContent
        }));

        forms.forEach(form => {
            form.addEventListener('submit', function(event) {
                event.preventDefault();

                const formData = new URLSearchParams(new FormData(this));
                const endpoint = this.getAttribute('data-endpoint');

                fetch(endpoint, {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        return response.json().then(data => ({
                            status: response.status,
                            data: data
                        }));
                    })
                    .then(({ status, data }) => {
                        if (status === 200) {
                            this.reset();
                            showStatus('success', data.message);
                            // –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤—Å—é —Å—Ç–æ—Ä—ñ–Ω–∫—É –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–ø–∏—Å–∫—ñ–≤ (–≤–∏–ø–∞–¥–∞—é—á–∏—Ö —Ç–∞ —Ç–∞–±–ª–∏—Ü—å)
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);
                        } else {
                            showStatus('error', data.message || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞.');
                        }
                    })
                    .catch(error => {
                        showStatus('error', '–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ –∞–±–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ API.');
                        console.error('Fetch error:', error);
                    });
            });
        });

        if (filterGenreSelect && songGroupSelect) {
            filterGenreSelect.addEventListener('change', function() {
                const selectedGenreId = this.value;

                // –Ø–∫—â–æ –æ–±—Ä–∞–Ω–æ "-- –í—Å—ñ –∂–∞–Ω—Ä–∏ --" –∞–±–æ –Ω—ñ—á–æ–≥–æ –Ω–µ –æ–±—Ä–∞–Ω–æ
                if (!selectedGenreId || selectedGenreId === "") {
                    // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ –ø–æ—á–∞—Ç–∫–æ–≤–∏–π —Å–ø–∏—Å–æ–∫
                    songGroupSelect.innerHTML = '';
                    initialGroups.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.value;
                        option.textContent = item.text;
                        songGroupSelect.appendChild(option);
                    });
                    return;
                }

                fetch(`/api/secure-add/groups-by-genre?genreId=${selectedGenreId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≥—Ä—É–ø: ' + response.status);
                        }
                        return response.json();
                    })
                    .then(groupsMap => {
                        // –û—á–∏—â–∞—î–º–æ —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø
                        songGroupSelect.innerHTML = '<option value="">-- –û–±–µ—Ä—ñ—Ç—å –≥—Ä—É–ø—É --</option>';

                        // –ó–∞–ø–æ–≤–Ω—é—î–º–æ —Å–ø–∏—Å–æ–∫ –≤—ñ–¥—Ñ—ñ–ª—å—Ç—Ä–æ–≤–∞–Ω–∏–º–∏ –≥—Ä—É–ø–∞–º–∏
                        for (const id in groupsMap) {
                            const name = groupsMap[id];
                            const option = document.createElement('option');
                            option.value = id;
                            option.textContent = name;
                            songGroupSelect.appendChild(option);
                        }

                        if (Object.keys(groupsMap).length === 0) {
                            showStatus('error', '–î–ª—è –æ–±—Ä–∞–Ω–æ–≥–æ –∂–∞–Ω—Ä—É –≥—Ä—É–ø–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ. –î–æ–¥–∞–π—Ç–µ –≥—Ä—É–ø—É —Å–ø–æ—á–∞—Ç–∫—É.', 5000);
                        }

                    })
                    .catch(error => {
                        showStatus('error', error.message || '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –≤—ñ–¥—Ñ—ñ–ª—å—Ç—Ä–æ–≤–∞–Ω—ñ –≥—Ä—É–ø–∏.', 5000);
                        songGroupSelect.innerHTML = '<option value="">-- –ü–æ–º–∏–ª–∫–∞ --</option>';
                    });
            });
        }


        function showStatus(type, message, timeout = 3000) {
            statusMessage.className = `message-box ${type}`;
            statusMessage.textContent = message;
            statusMessage.style.display = 'block';

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—Ä–∏—Ö–æ–≤–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —á–µ—Ä–µ–∑ –∑–∞–¥–∞–Ω–∏–π —á–∞—Å
            clearTimeout(statusMessage.timer);
            statusMessage.timer = setTimeout(() => {
                statusMessage.style.display = 'none';
            }, timeout);
        }
    });
</script>
</body>
</html>